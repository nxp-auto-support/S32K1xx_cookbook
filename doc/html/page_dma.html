<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Direct Memory Access (DMA)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="s32k1xx_cookbook_logo.jpg"/></td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">S32K1xx Series Cookbook</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Direct Memory Access (DMA) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Description </h2>
<p>Summary: Initialize an eDMA channel’s Transfer Control Descriptor (TCD) to transfer a string of bytes (“Hello world”) from an array in SRAM to a single SRAM byte location.<br />
 This emulates a common use of DMA, where a string of data or commands is transferred automatically under DMA control to an input register of a peripheral.<br />
 The intent of this example is to illustrate how to set up a DMA transfer.<br />
<br />
 </p><div class="image">
<img src="Diagram_DMA_project.png" alt="Diagram_DMA_project.png"/>
</div>
<p>The DMA MUX is required when using DMA with peripherals.<br />
 Peripheral assignment numbers for mapping to a DMA channel are listed in the reference manual’s attached spreadsheet S32K1xx_DMA_Interrupt_mapping, DMA_CH_MUX tab.<br />
 For a software triggered transfer as in this example, DMA MUX is not required.<br />
Interrupts, not used in this tutorial level example, are useful when all the desired transfers or half of them are complete.<br />
One use case is to have a peripheral like ADC generate a DMA request after a conversion completes. The DMA controller can automatically transfer the conversion result to SRAM. <br />
After a desired number of conversions, the DMA controller can generate an interrupt request for that channel.<br />
</p>
<p>Channel linking and scatter-gather (SGA) are advanced features that enable a DMA request to allow multiple different transfers on each DMA request, and/or to use a different TCD for each DMA request.<br />
These powerful features can be used with peripheral(s) to implement a state machine type sub-system.<br />
 Example: An input signal generates a DMA request which transfers data to initialize multiple peripherals.<br />
Minor loop mapping is normally not used in MCU level applications, but can be powerful for graphics to rotate images in increments of 45 degrees.<br />
Because a peripheral is not involved in this example, automatic DMA handshaking will not occur.<br />
Instead, the software handshaking given here must be implemented for each DMA request (minor loop transfer):<br />
</p><ul>
<li>Start DMA service request (set a START bit for desired channel).<br />
</li>
<li>Wait for the minor loop transfer to complete by polling for START and ACTIVE status.<br />
</li>
<li>Repeat above two steps until major loop is complete as indicated by DONE bit.<br />
<br />
These steps appear “messy” for every transfer, which is only a byte in this example. However, when using actual peripherals, software never has to do these steps; they are done automatically by hardware.<br />
 The START bit is normally set with hardware by the peripheral requesting service. Once the DMA processing engine activates the channel, the ACTIVE bit is set. <br />
If the DMA engine was busy servicing other channels, one could cancel the transfer by clearing the START bit. <br />
The ACTIVE bit would then need to be checked to ensure service did not start on that channel.<br />
As an exercise, the TCD can be modified so the destination is an array instead of a single byte location.<br />
(Hint: declare the destination as a string and change DOFF=1.)<br />
 <h2>Design </h2>
</li>
</ul>
<p>TCDs describe the data to be transferred and how the transfer is controlled. Each TCD occupies eight<br />
32-bit words in a RAM internal to the eDMA structure as summarized in the following figure and table.<br />
<br />
 </p><div class="image">
<img src="Table_DMA_TCD.png" alt="Table_DMA_TCD.png"/>
</div>
<p> <br />
</p><ul>
<li><a class="el" href="dma_tcd_hf.html">TCD initialization with NXP S32K144 header file</a> <br />
</li>
</ul>
<p>Disable watchdog<br />
</p><ul>
<li>System clocks: Initialize SOSC for 8 MHz, sysclk 80 MHz, RUN mode for 80 MHz<br />
</li>
<li>Initialize DMA controller:<br />
<ul>
<li>Enable clock to DMA MUX module (Not required if software initiates DMA with START bit.)<br />
</li>
<li>Enable desired channels. (Not required if software initiates DMA with START bit.)<br />
</li>
</ul>
</li>
<li>Initialize DMA Transfer Control Descriptors (Only TCD0 is used here):<br />
<ul>
<li>Source<br />
<ul>
<li>Source address (SADDR): Use address of a string “Hello World”<br />
</li>
<li>Source offset (SOFF): Increment source address by 1 byte for each transfer<br />
</li>
<li>Source modulo (SMOD): Feature not used here<br />
</li>
<li>Source size (SSIZE): Read 1 byte at a time<br />
</li>
<li>Source last address adjustment (SLAST): Decrement source address by 11 after major loop<br />
</li>
</ul>
</li>
<li>Destination<br />
<ul>
<li>Destination address (DADDR): Use address of a single byte<br />
</li>
<li>Destination offset (DOFF): Do not add offset to destination address after minor loop<br />
</li>
<li>Destination modulo (DMOD): Feature not used here<br />
</li>
<li>Destination size (DSIZE): Write 1 byte at a time<br />
</li>
<li>Destination last address adjustment (DLAST): Do not adjust address after major loop<br />
</li>
<li>Number of bytes per DMA request and number of iterations (minor loops)<br />
</li>
<li>Number of bytes to be transferred per DMA request (NBYTES): One byte<br />
</li>
<li>Number of iterations/minor loops in major loop (CITER and BITER): 11<br />
</li>
<li>Channel to channel linking for additional iterations after minor loop (BITER ELINK and CITER ELINK): Disabled<br />
</li>
</ul>
</li>
<li>Controls and Status<br />
<ul>
<li>Disable channel after major loop completes (DREQ): Disable channel<br />
</li>
<li>Generate interrupt request half way through major loop (INTHALF): Disabled<br />
</li>
<li>Generate interrupt request after completing major loop (INTMAJOR): Disabled<br />
</li>
<li>Enable Scatter-Gather (ESG): Disabled. No other TCDs loaded to channel<br />
</li>
<li>Enable channel link after major loop (MAJORLINK): Disabled<br />
</li>
<li>Channel link number after major loop (MAJORLINKCH): Null - feature disabled<br />
</li>
<li>Band Width Control (BWC): Set to 0 so there are no stalls after R/W<br />
</li>
<li>Clear initial values of status flags (START, ACTIVE, DONE): Set to zero<br />
</li>
</ul>
</li>
</ul>
</li>
<li>Start first transfer (set START = 1) and wait for transfer to complete (START=0, ACTIVE=0)<br />
</li>
<li>Loop: While the channel’s DONE status is not set:<br />
<ul>
<li>Start next transfer (set START = 1) and wait for transfer to complete (START=0, ACTIVE=0)<br />
</li>
</ul>
</li>
<li>Clear channel’s DONE status bit<br />
<br />
<h2>Driver Functions: </h2>
</li>
</ul>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Function  </th><th class="markdownTableHeadNone">Driver   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="dma_8h.html#aa66c347825b338e479bcda339736f4af">DMA_init</a>  </td><td class="markdownTableBodyNone">dma   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="dma_8h.html#afed8cea4cbb2a61498e98db87414956b">DMA_TCD_init</a>  </td><td class="markdownTableBodyNone">dma   </td></tr>
</table>
<p><br />
</p><h2>main.c </h2>
<div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;device_registers.h&quot;</span>  <span class="comment">/* Include peripheral declarations */</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="dma_8h.html">dma.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="clocks__and__modes_8h.html">clocks_and_modes.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> WDOG_disable (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">  WDOG-&gt;CNT=0xD928C520;     <span class="comment">/* Unlock watchdog      */</span></div><div class="line">  WDOG-&gt;TOVAL=0x0000FFFF;   <span class="comment">/* Maximum timeout value    */</span></div><div class="line">  WDOG-&gt;CS = 0x00002100;    <span class="comment">/* Disable watchdog         */</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">  WDOG_disable();        <span class="comment">/* Disable WDOG */</span></div><div class="line">  <a class="code" href="clocks__and__modes_8c.html#a2f05a0e5aa290fba55984156198f14a2">SOSC_init_8MHz</a>();      <span class="comment">/* Initialize system oscillator for 8 MHz xtal */</span></div><div class="line">  <a class="code" href="clocks__and__modes_8c.html#a5b337515ef6255432800f7793441527c">SPLL_init_160MHz</a>();    <span class="comment">/* Initialize SPLL to 160 MHz with 8 MHz SOSC */</span></div><div class="line">  <a class="code" href="clocks__and__modes_8c.html#aa234261bbd2c76d65303e209757dc19b">NormalRUNmode_80MHz</a>(); <span class="comment">/* Init clocks: 80 MHz sysclk &amp; core, 40 MHz bus, 20 MHz flash */</span></div><div class="line"></div><div class="line">  <a class="code" href="dma_8c.html#aa66c347825b338e479bcda339736f4af">DMA_init</a>();              <span class="comment">/* Init DMA controller */</span></div><div class="line">  <a class="code" href="dma_8c.html#afed8cea4cbb2a61498e98db87414956b">DMA_TCD_init</a>();          <span class="comment">/* Init DMA Transfer Control Descriptor(s) */</span></div><div class="line"></div><div class="line">  DMA-&gt;SSRT = 0;           <span class="comment">/* Set chan 0 START bit to initiate first minor loop */</span></div><div class="line">  <span class="keywordflow">while</span> (((DMA-&gt;TCD[0].CSR &gt;&gt; DMA_TCD_CSR_START_SHIFT) &amp; 1) |       <span class="comment">/* Wait for START = 0 */</span></div><div class="line">         ((DMA-&gt;TCD[0].CSR &gt;&gt; DMA_TCD_CSR_ACTIVE_SHIFT)  &amp; 1))  {}  <span class="comment">/* and ACTIVE = 0 */</span></div><div class="line">                                                                    <span class="comment">/* Now minor loop has completed */</span></div><div class="line"></div><div class="line">  <span class="keywordflow">while</span> (!((DMA-&gt;TCD[0].CSR &gt;&gt; DMA_TCD_CSR_DONE_SHIFT) &amp; 1) ) {    <span class="comment">/* Loop till DONE = 1 */</span></div><div class="line">    <span class="comment">/* Place breakpoint at next instruction &amp; observe expressions TCD0_Source, TCD0_Dest */</span></div><div class="line">    DMA-&gt;SSRT = 0;  <span class="comment">/* Set chan 0 START bit to initiate next minor loop */</span></div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (((DMA-&gt;TCD[0].CSR &gt;&gt; DMA_TCD_CSR_START_SHIFT) &amp; 1) |         <span class="comment">/* Wait for START = 0 */</span></div><div class="line">           ((DMA-&gt;TCD[0].CSR &gt;&gt; DMA_TCD_CSR_ACTIVE_SHIFT)  &amp; 1))  {}    <span class="comment">/* and ACTIVE = 0 */</span></div><div class="line">                                                                        <span class="comment">/* Now minor loop has completed */</span></div><div class="line">  }</div><div class="line"></div><div class="line">  DMA-&gt;TCD[0].CSR &amp;= ~(DMA_TCD_CSR_DONE_MASK);   <span class="comment">/* Clear DONE bit */</span></div><div class="line"></div><div class="line">  <span class="keywordflow">while</span> (1) {}</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
